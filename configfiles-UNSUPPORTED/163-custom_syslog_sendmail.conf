filter {
    if ([type] == "archive-syslog" or [type] == "syslog") {
        if [syslog_program] == "sendmail" {
            # t1CGWwfs001773: from=<usr1@domain1.tld>, size=9191, class=0, nrcpts=0, proto=ESMTP, daemon=MTA, relay=[87.116.65.57]
            # t1CGZZuH002993: to=<user@host.tld>, delay=00:00:01, xdelay=00:00:01, mailer=local, pri=96121, dsn=2.0.0, stat=Sent
            # t1CGZ1hJ002734: Milter: to=<user3@host3.tld>, reject=451 4.7.1 Greylisting in action, please come back later

            grok {
                match => [ "message", "%{NOTSPACE:smtp_id}: (?:%{WORD:smtp_subsystem}: )?%{GREEDYDATA:message_remainder}" ]
                add_tag => [ "got_smtp_id", "got_smtp_subsystem" ]
            }
            if "got_smtp_id" in [tags] and [message_remainder] and [message_remainder] != "" {
                mutate {
                    replace => [ "message", "%{message_remainder}" ]
                }
            }

            if "got_smtp_id" in [tags] {
                mutate {
                    # XXX must not be combined with replacement which uses same field
                    remove_field => [ "message_remainder" ]
                }
            }
            
            kv {
                prefix => "smtp_"
                trim => "<>\[\],"
                field_split => ","
                trimkey => " "
            }
        }
    }
}