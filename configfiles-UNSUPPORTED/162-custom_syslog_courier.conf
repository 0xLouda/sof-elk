filter {
    if ([type] == "archive-syslog" or [type] == "syslog") {
        if [syslog_program] == "courier-pop3d" {
        # LOGIN, user=user@host.tld, ip=[::ffff:1.2.3.4], port=[63641]
        #Connection, ip=[::ffff:1.2.3.4]
        #Disconnected, ip=[::ffff:1.2.3.4]
            grok {
                match => [ "message", "^%{WORD:pop3_event},(?: user=%{NOTSPACE:pop3_username},)? ip=\[::ffff:%{IP:pop3_srcip}\](?:, port=\[%{POSINT:pop3_srcport}\])?$" ]
                add_tag => [ "got_pop3_event", "parse_done" ]
                tag_on_failure => [ "_gpfail_pop3event" ]
            }
        }

        if [pop3_srcip] {
            geoip {
                database => "/usr/local/share/GeoIP/GeoIPASNum.dat"
                source => "[pop3_srcip]"
                target => "[pop3_srcgeo]"
            }
            geoip {
                database => "/usr/local/share/GeoIP/GeoLiteCity.dat"
                source => "[pop3_srcip]"
                target => "[pop3_srcgeo]"
            }
        }
        if [pop3_srcgeo][ip] {
            mutate {
                remove_field => [ "[pop3_srcgeo][ip]" ]
            }
        }
    }

    if "got_pop3_event" in [tags] {
        if [pop3_srcip] and [ips] {
            mutate {
                replace => [ "ips", "%{ips} %{pop3_srcip}" ]
            }
        } else if [pop3_srcip] {
            mutate {
                add_field => { "ips" => "%{pop3_srcip}" }
            }
        }
    }
}