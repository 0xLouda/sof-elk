# SOF-ELK Configuration File
# (C)2016 Lewes Technology Consulting, LLC
#
# This file contains filters, transforms, and enrichments for other syslog messages

filter {
    if "process_syslog" in [tags] and !("parse_done" in [tags]) {
        # iptables firewall messages
        grok {
            patterns_dir => "/usr/local/sof-elk/grok-patterns"
            match => [ "message", "(?:\[%{BASE10NUM:uptime:float}\]%{SPACE})?%{IPTABLES}" ]
            add_tag => [ "got_iptables", "parse_done" ]
            tag_on_failure => [ "_defaultparse" ]
        }
        if "got_iptables" in [tags] and [source_ip] {
            geoip {
                database => "/usr/local/share/GeoIP/GeoIPASNum.dat"
                source => "[source_ip]"
                target => "[source_geo]"
            }
            geoip {
                database => "/usr/local/share/GeoIP/GeoLiteCity.dat"
                source => "[source_ip]"
                target => "[source_geo]"
            }
            mutate {
                add_field => {
                    "ips" => [ "%{source_ip}", "%{destination_ip}" ]
                }
            }
        }
        if [source_geo][ip] {
            mutate {
                remove_field => [ "[source_geo][ip]" ]
            }
        }
        if "got_iptables" in [tags] and [destination_ip] {
            geoip {
                database => "/usr/local/share/GeoIP/GeoIPASNum.dat"
                source => "[destination_ip]"
                target => "[destination_geo]"
            }
            geoip {
                database => "/usr/local/share/GeoIP/GeoLiteCity.dat"
                source => "[destination_ip]"
                target => "[destination_geo]"
            }
        }
        if [destination_geo][ip] {
            mutate {
                remove_field => [ "[destination_geo][ip]" ]
            }
        }
    }
}