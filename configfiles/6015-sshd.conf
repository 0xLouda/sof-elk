# SOF-ELK Configuration File
# (C)2016 Lewes Technology Consulting, LLC
#
# This file contains filters, transforms, and enrichments for SSH server messages

# Messages to handle:
# Received disconnect from 192.168.75.43: 11: disconnected by user
# subsystem request for sftp
# reverse mapping checking getaddrinfo for ansible [192.168.75.43] failed - POSSIBLE BREAK-IN ATTEMPT!

filter {
    # SSH login messages
    if (([type] == "syslog") and [syslog_program] == "sshd") {
        grok {
            patterns_dir => "/usr/local/sof-elk/grok-patterns"
            match => [ "message", "^%{WORD:login_result} %{WORD:login_method} for %{USERNAME:user} from %{IPORHOST:source_ip} port %{POSINT} %{WORD:ssh_protocol}(?:: %{WORD:key_type} %{SSH_KEYID:key_id})?$" ]
            add_tag => [ "got_sshlogin", "parse_done" ]
            tag_on_failure => [ "_gpfail_sshlogin" ]
        }
    }

    if "_gpfail_sshlogin" in [tags] {
        mutate {
            remove_tag => [ "_gpfail_sshlogin"]
        }
    }
}